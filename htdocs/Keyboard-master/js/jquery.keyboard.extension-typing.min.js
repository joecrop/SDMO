/* jQuery UI Virtual Keyboard Typing Simulator v1.6 for Keyboard v1.18+ only (1/3/2015)
 * By Rob Garrison ~ MIT license ~ https://github.com/Mottie/Keyboard */
;(function(h){h.fn.addTyping=function(k){var l={showTyping:!0,lockTypeIn:!1,delay:250};return this.each(function(){var b,a=h(this).data("keyboard");a&&(b=a.typing_options=h.extend({},l,k),a.typing_keymap={" ":"space",'"':"34","'":"39","&nbsp;":"space","\b":"bksp","\n":"Enter","\r":"Enter","\t":"tab"},a.typing_xref={8:"bksp",9:"tab",13:"enter",32:"space"},a.typing_event=!1,b.savedLockInput=a.options.lockInput,a.typing_setup=function(){(a.$preview?a.$preview:a.$el).bind("keyup.keyboard",function(c){if(b.init&& b.lockTypeIn)return!1;37<=c.which&&40>=c.which||(16===c.which&&(a.shiftActive=!1),18===c.which&&(a.altActive=!1),16!==c.which&&18!==c.which)||(a.showKeySet(),setTimeout(function(){a.$preview.focus()},200))}).bind("keydown.keyboard",function(c){if(b.init&&b.lockTypeIn)return!1;c.temp=!1;16===c.which&&(c.temp=!a.shiftActive,a.shiftActive=!0);18===c.which&&(c.temp=!a.altActive,a.altActive=!0);c.temp&&(a.showKeySet(),a.$preview.focus());a.typing_event=!0;8!==c.which&&9!==c.which||a.typing_findKey("", c)}).bind("keypress.keyboard",function(c){if(b.init&&b.lockTypeIn)return!1;a.typing_event&&!a.options.lockInput&&a.typing_findKey("",c)})},a.typeIn=function(c,e,f,d){a.isVisible()?a.typing_event?"undefined"===typeof c&&(a.typing_event=!1,a.options.lockInput=b.savedLockInput):(!0!==b.init&&(b.init=!0,a.options.lockInput=b.lockTypeIn,c=b.text=c||"",b.len=c.length-1,b.delay=e||300,b.current=0,f&&(b.callback=f)),c=b.text.substring(b.current,++b.current),a.typing_findKey(c,d)):(a.typing_event=b.init=!1, a.options.lockInput=b.savedLockInput,clearTimeout(a.typing_timer))},a.typing_findKey=function(c,e){var f,d,g;d=h.keyboard.builtLayouts[a.layout].mappedKeys;g=a.$keyboard.find(".ui-keyboard-keyset");f='.ui-keyboard-button[data-value="'+(a.typing_keymap.hasOwnProperty(c)?a.typing_keymap[c]:c)+'"]';a.typing_event&&e&&(a.typing_xref.hasOwnProperty(e.keyCode||e.which)?f=".ui-keyboard-"+a.typing_xref[e.keyCode||e.which]:(f=String.fromCharCode(e.charCode||e.which),f=d.hasOwnProperty(f)?'.ui-keyboard-button[data-value="'+ d[f]+'"]':".ui-keyboard-"+(e.charCode||e.which)));d=g.filter(":visible").find(f);d.length?a.typing_simulateKey(d,c):(a.typing_event?d=g.find(f):(d=a.typing_keymap.hasOwnProperty(c)?a.typing_keymap[c]:c.charCodeAt(0),"bksp"===d&&(c=d),d=g.find(".ui-keyboard-"+d)),g=d.closest(".ui-keyboard-keyset"),g.attr("name")?(g=g.attr("name"),a.shiftActive=/shift/.test(g),a.altActive=/alt/.test(g),a.metaActive=a.last.keyset[2]=g.match(/meta\d+/)||!1,a.showKeySet({name:a.metaActive}),a.typing_simulateKey(d,c)): a.typing_event||(a.insertText(c),a.checkCombos()));b.current<=b.len&&0!==b.len?a.isVisible()&&setTimeout(function(){a.typeIn()},b.delay):0!==b.len?(a.typing_event=b.init=!1,a.options.lockInput=b.savedLockInput,b.len=b.current=0,h.isFunction(b.callback)&&setTimeout(function(){h.isFunction(b.callback)&&b.callback(a)},b.delay)):(b.len=b.current=0,b.text="",a.typing_event=b.init=!1,a.options.lockInput=b.savedLockInput)},a.typing_simulateKey=function(c,e){c.length&&c.filter(":visible").trigger("mouseenter.keyboard"); a.typing_timer=setTimeout(function(){c.length&&setTimeout(function(){c.trigger("mouseleave.keyboard")},b.delay/3);a.isVisible()&&!a.typing_event&&(a.insertText(e),a.checkCombos())},b.delay/3)},b.showTyping&&(a.options.alwaysOpen&&a.isVisible()&&a.typing_setup(),a.$el.bind("visible.keyboard",function(){a.typing_setup()})))})}})(jQuery);
